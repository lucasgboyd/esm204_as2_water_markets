---
title: "hw2"
author: "Lucas Boyd"
date: "4/12/2022"
output: 
  html_document:
    theme: spacelab
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(here)
library(janitor)
library(broom)
library(equatiomatic)
library(kableExtra)
```
# Intro {.tabset .tabset-pills}

## 1. Marginal Abatement
```{r}
water <- read_csv(here("data", "Water_Districts.csv")) %>% 
  clean_names() %>% 
  mutate(mc_aggregate = mc_kern + mc_antelope + mc_ventura + mc_mojave)

water_longer <- water %>% 
  pivot_longer(cols = c(3:6), names_to = "county", values_to = "mc") %>% 
  mutate(county = case_when(
    county == "mc_kern" ~ "Kern", 
    county == "mc_antelope" ~ "Antelope", 
    county == "mc_ventura" ~ "Ventura", 
    county == "mc_mojave" ~ "Mojave",
    county == "mc_aggregate" ~ "Aggregate"
  ))
```

```{r}
ggplot(data = water_longer, 
       aes(x = reduction, y = mc, color = county)) +
  geom_line(size = 0.3) + 
  geom_smooth(method = "lm") +
  theme_minimal(14) +
  labs (y = "Marginal cost of abatement ($/acre foot)", 
        x = "Level of reduction (acre feet)") +
  scale_color_manual(values = c("cyan4", "goldenrod4", "firebrick", "forestgreen", "black")) +
  theme(legend.position = c(0.2, 0.7))
```

**Figure 1** shows marginal cost of abatement of water use for each district.
```{r}
lm_kern <- lm(mc_kern ~ 0 + reduction, data = water)
lm_ventura <- lm(mc_ventura ~ 0 + reduction, data = water)
lm_antelope <- lm(mc_antelope ~ 0 + reduction, data = water)
lm_mojave <- lm(mc_mojave ~ 0 + reduction, data = water)
lm_aggregate <- lm(mc_aggregate ~ 0 + reduction, data = water)
```

### Linear models
Estimating the marginal abatement cost for each district and the aggregate of all districts. 
```{r}
extract_eq(lm_kern, use_coefs = TRUE)
extract_eq(lm_ventura, use_coefs = TRUE)
extract_eq(lm_antelope, use_coefs = TRUE)
extract_eq(lm_mojave, use_coefs = TRUE)
extract_eq(lm_aggregate, use_coefs = TRUE)
```

```{r}
slope_kern <- lm_kern$coefficients[1]
slope_ventura <- lm_ventura$coefficients[1]
slope_antelope <- lm_antelope$coefficients[1]
slope_mojave <- lm_mojave$coefficients[1]
slope_aggregate <- 1/slope_kern + 1/slope_ventura + 1/slope_antelope + 1/slope_mojave
```

## 2. Demand Curves

```{r}
demand_vector <- c(0:250)

use_kern <- 150
use_mojave <- 140
use_antelope <- 220
use_ventura <- 245
use_aggregate <- 755

demand_df <- data.frame(demand_vector) %>% 
  mutate(mb_kern = slope_kern*(use_kern - demand_vector)) %>% 
  mutate(mb_ventura = slope_ventura*(use_ventura - demand_vector)) %>%  
  mutate(mb_mojave = slope_mojave*(use_mojave - demand_vector)) %>% 
  mutate(mb_antelope = slope_antelope*(use_antelope - demand_vector)) %>%
  pivot_longer(cols = c(2:5), names_to = "county", values_to = "mb") %>% 
  mutate(county = case_when(
    county == "mb_kern" ~ "Kern", 
    county == "mb_antelope" ~ "Antelope", 
    county == "mb_ventura" ~ "Ventura", 
    county == "mb_mojave" ~ "Mojave"
  ))

ggplot(data = demand_df, aes(x = demand_vector, y = mb, color = county)) +
  geom_line(size = 1) +
  theme_minimal(14) +
  scale_y_continuous(limits = c(0, 750)) +
  labs (y = "Marginal benefit of water use ($/acre foot)", 
        x = "Water use (consumption) (acre feet)") +
  scale_color_manual(values = c("cyan4", "goldenrod4", "firebrick", "forestgreen")) +
  theme(legend.position = c(0.8, 0.7)) 
```

**Figure 2** shows marginal willingness to pay for water for each district. 

**The Mojave Water district** is willing to pay the most for the first acre foot of water, at a price of **$628.68**. 

## 3. Policy interventions
In total, these irrigation districts will need to reduce water consumption from the current 755 AF down
to 500 AF. For each intervention listed below, perform the following calculations: (1) calculate the
stringency of the policy (defined below for each intervention) required to achieve the 500 AF target, 
(2)
calculate the total cost of meeting the target using that approach, 
(3) calculate the cost to each district,
and (4) calculate the tax revenue generated.
#### a. Cap without trade. Reduce each districtâ€™s water use by the same fraction (e.g., 1/3 of current
baseline use), so the 500 AF target is met. Trade is not allowed. Stringency is defined as the
magnitude of the fraction.

```{r}
stringency_a <- 1-(500/use_aggregate)

use <- c(use_kern, use_mojave, use_antelope, use_ventura, use_aggregate)
district <- c("Kern", "Mojave", "Antelope", "Ventura", "Aggregate")
mca_slope <- c(slope_kern, slope_mojave, slope_antelope, slope_ventura, slope_aggregate)

cap_no_trade <- data.frame(district, use, mca_slope) %>%
  filter(district != "Aggregate") %>% 
  mutate(water_use_new = (use*(500/use_aggregate))) %>%
  mutate(abatement = use - water_use_new) %>% 
  mutate(total_cost = (abatement*(abatement*mca_slope))/2) %>% # area under the MCA curve
  mutate(stringency = stringency_a)

kable(cap_no_trade, digits = 3) %>% 
  kable_minimal(full_width = FALSE)

## total_cost <- ### calculate total costs to each district
## tax revenue 
```

#### b. Tax on water use. A single tax is implemented on all water use in each of the four districts, such
that water use is reduced to the 500 AF target. Stringency is defined as the magnitude of the
tax.

```{r}

```

#### c. Cap and trade. Cap water use as in part (a), but after those caps are set, allow trade across
districts. How much water is used by each district after trade? Stringency is the same as in part
(a).

## 4. Drought
A severe drought hits California, and it is necessary to reduce water use from 500 AF down to 300 AF. Your
job is to estimate the cost of the drought (i.e., the cost of reducing water use from 500 AF to 300 AF) to
each irrigation district under each policy. Considering the entire jump from status quo (755 AF) to the
drought (300 AF), which policy is preferred by each irrigation district? How does your answer depend on
how rights are allocated to each district (in policies (a) and (c))2? 




